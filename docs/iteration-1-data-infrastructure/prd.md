# 股票预测系统 - 迭代1：数据获取基础设施

## 产品概述

### 产品背景
股票预测系统需要高质量、实时的金融数据作为核心基础。本迭代专注于构建数据获取基础设施，为后续的因子计算、预测模型等功能提供数据支撑。

### 产品定位
- **目标用户**：量化分析师、系统管理员
- **使用场景**：自动化数据采集和实时数据查询
- **核心价值**：提供准确、及时、完整的金融数据基础

### 产品目标
- 建立可靠的数据获取能力，覆盖A股全市场
- 确保数据准确率>99%，数据延迟<5分钟
- 支撑股票预测系统的数据需求

## 需求分析

### 功能需求

#### 1. 股票基础数据采集
- 股票基本信息（代码、名称、行业、市值等）
- 日K线数据（开盘价、收盘价、最高价、最低价、成交量、成交额）
- 分钟级K线数据（用于实时监控）
- 股票列表维护（A股主板、创业板、科创板）
- 股票复权因子（前复权、后复权因子数据）
- 全量数据初始化（支持一次性采集全市场股票基本信息）

#### 2. 财务数据采集
- 资产负债表数据
- 利润表数据
- 现金流量表数据
- 财务指标数据（PE、PB、ROE、ROA等）

#### 3. 市场数据采集
- 大盘指数数据（上证指数、深证成指、创业板指、科创50等）
- 行业指数数据（申万一级、二级行业指数）
- 板块分类数据（概念板块、地域板块、行业板块）
- 板块成分股数据（各板块包含的股票列表及权重）
- 指数历史数据（开盘价、收盘价、最高价、最低价、成交量等）

#### 4. 新闻数据采集
- 财经新闻（新浪财经、东方财富、财联社等）
- 公司公告和研报
- 实时快讯和市场动态
- 社交媒体情绪数据（股吧、微博、雪球等）

#### 5. 政策数据采集
- 央行货币政策和利率公告
- 证监会政策法规和监管动态
- 交易所规则和公告
- 宏观经济政策解读

#### 6. 数据服务
- 数据查询API
- 历史数据管理

#### 7. Token管理
- 多Token配置管理（支持配置多个Tushare Pro API token）
- Token轮换策略（按请求次数或时间间隔轮换使用）
- 异常处理机制（token失效或达到限制时自动切换到下一个可用token）

### 用户需求

#### 用户故事1：数据采集
**作为** 系统管理员  
**我希望** 系统能够自动采集股票基础数据和财务数据  
**以便** 为后续的分析和预测提供数据基础

#### 用户故事2：数据查询
**作为** 后端服务  
**我希望** 能够通过API快速查询所需的股票数据  
**以便** 进行因子计算和模型训练

#### 用户故事3：Token管理
**作为** 系统管理员  
**我希望** 系统能够自动管理和轮换多个Tushare Pro API token  
**以便** 避免单个token的频率限制，确保数据采集的连续性和稳定性

### 业务需求

#### 数据覆盖范围
- A股全市场股票数据
- 历史数据3年以上
- 主要指数和行业数据
- 财经新闻和政策信息
- 社交媒体情绪数据

#### 数据更新频率
- 日K线数据：每日收盘后30分钟内更新
- 财务数据：季报发布后7天内更新
- 基础信息：每周更新一次
- 实时数据：交易时间内每5分钟更新
- 新闻数据：每10分钟更新
- 政策数据：每小时更新

#### 数据质量要求
- 数据完整性：单日数据缺失率<1%
- 数据准确性：与官方数据一致性>99%
- 数据时效性：数据延迟<5分钟

#### 数据源访问控制
- Tushare Pro API Token轮换：配置多个有效token，系统自动轮换使用
- Token使用策略：按请求次数或时间间隔轮换，避免单个token频率限制
- 异常处理：当token失效或达到限制时，自动切换到下一个可用token

## 产品功能设计

### 数据采集器详细设计

#### 1. 股票基础数据采集器

**数据源**：
- 主要数据源：Tushare Pro API
- 备用数据源：东方财富、新浪财经

**采集内容**：
- 股票基本信息：股票代码、名称、所属行业、上市日期、总股本、流通股本、市值
- 日K线数据：开盘价、收盘价、最高价、最低价、成交量、成交额、涨跌幅
- 分钟级K线数据：1分钟、5分钟、15分钟、30分钟、60分钟K线
- 股票列表：A股主板、创业板、科创板、北交所股票清单
- 股票复权因子：前复权因子、后复权因子、除权除息日期、复权类型
- 全量初始化：支持一次性采集全市场股票基本信息的手动触发接口

**采集策略**：
- 基础信息：每周日凌晨2点全量更新
- 日K线：每个交易日收盘后30分钟内增量更新
- 分钟K线：交易时间内每5分钟增量更新
- 股票列表：每月1日全量更新
- 复权因子：每个交易日收盘后1小时内更新，除权除息日当天优先更新
- 全量初始化：提供手动触发接口，支持系统初始化时一次性采集全市场数据

**验收标准**：
- 覆盖A股全市场>95%的股票
- 日K线数据完整率>99%
- 数据更新延迟<30分钟
- 与官方数据一致性>99%
- 复权因子数据完整率>95%
- 全量初始化接口能够在30分钟内完成全市场股票基本信息采集
- 复权因子查询接口响应时间<500ms

#### 2. 财务数据采集器

**数据源**：
- 主要数据源：Tushare Pro API
- 备用数据源：同花顺、东方财富

**采集内容**：
- 资产负债表：总资产、总负债、股东权益、流动资产、固定资产等
- 利润表：营业收入、净利润、毛利润、营业利润、EBITDA等
- 现金流量表：经营活动现金流、投资活动现金流、筹资活动现金流
- 财务指标：PE、PB、ROE、ROA、毛利率、净利率、资产负债率等

**采集策略**：
- 季报数据：每季度财报发布后7天内更新
- 年报数据：年报发布后3天内更新
- 财务指标：每日收盘后计算更新

**验收标准**：
- 财务数据覆盖率>95%
- 季报更新及时率>90%（7天内）
- 财务指标计算准确率>99%

#### 3. 市场数据采集器

**数据源**：
- 主要数据源：Tushare Pro API
- 备用数据源：上交所、深交所官方数据

**采集内容**：
- 大盘指数：上证指数、深证成指、创业板指、科创50、沪深300、中证500等
- 行业指数：申万一级行业指数、中信行业指数
- 板块数据：概念板块、地域板块、风格板块

**采集策略**：
- 指数数据：交易时间内每5分钟更新
- 板块分类：每周更新

**验收标准**：
- 主要指数覆盖率100%
- 行业指数覆盖率>90%
- 数据更新延迟<5分钟

#### 4. 新闻数据采集器

**数据源及具体页面**：

**财联社**：
- 主页快讯：`https://www.cls.cn/telegraph`

**采集内容**：
- 快讯标题：简短的新闻标题
- 快讯内容：简要的新闻描述
- 发布时间：快讯发布的时间戳
- 关联股票：快讯中提及的股票代码和股票名称（如有）
- 关联行业：快讯中涉及的行业分类（如有）

**采集策略**：
- 财经新闻：每10分钟全网扫描
- 公司公告：每30分钟检查更新
- 社交媒体：每小时采集热门内容
- 反爬虫策略：随机User-Agent、代理IP池、请求间隔控制

**验收标准**：
- 主流财经媒体覆盖率>90%
- 新闻更新延迟<10分钟
- 公告采集完整率>95%
- 情绪分析准确率>80%
- 页面解析成功率：各数据源页面解析成功率>95%

#### 5. 政策数据采集器

**数据源及具体页面**：

**央行**：
- 新闻发布：`http://www.pbc.gov.cn/goutongjiaoliu/113456/113469/index.html`

**采集内容**：
- 货币政策：利率调整、准备金率、公开市场操作
- 监管政策：证监会规则、交易所制度、行业监管
- 宏观政策：财政政策、产业政策、区域政策
- 政策解读：官方解读、专家分析、市场影响

**采集策略**：
- 重要政策：实时监控，30分钟内采集
- 常规政策：每小时扫描更新
- 政策解读：每日汇总分析
- 反爬虫策略：遵守robots.txt、合理请求频率、官方API优先

**验收标准**：
- 重要政策采集及时率>95%
- 政策分类准确率>90%
- 政策影响分析覆盖率>80%
- 页面解析成功率：各数据源页面解析成功率>95%

### 数据清洗器详细设计

#### 1. 数据清洗器的作用

数据清洗器是数据采集流程中的关键环节，负责对原始采集数据进行标准化处理，确保数据质量满足后续分析和计算的要求。

**核心价值**：
- 提高数据质量：清除错误、重复、不完整的数据
- 统一数据格式：标准化不同数据源的格式差异
- 增强数据可用性：补全缺失数据，修正异常值
- 保证数据一致性：确保同一数据在不同时间点的一致性

#### 2. 股票数据清洗器

**清洗规则**：
- 价格数据验证：开盘价≤最高价，收盘价≤最高价，开盘价≥最低价，收盘价≥最低价
- 成交量验证：成交量≥0，成交额=成交量×均价（误差<1%）
- 涨跌幅验证：涨跌幅=（收盘价-前收盘价）/前收盘价×100%（误差<0.1%）
- 异常值检测：单日涨跌幅>20%需要二次验证
- 停牌数据处理：停牌期间数据标记，成交量为0

**数据补全策略**：
- 缺失K线：使用前一交易日收盘价填充
- 缺失成交量：标记为0并记录异常
- 缺失基本信息：从备用数据源补充

**验收标准**（可通过单元测试验证）：
- 价格逻辑验证：`开盘价 <= 最高价 && 收盘价 <= 最高价 && 开盘价 >= 最低价 && 收盘价 >= 最低价`
- 成交量非负验证：`成交量 >= 0`
- 成交额计算验证：`|成交额 - 成交量 × 均价| / (成交量 × 均价) < 0.01`
- 涨跌幅计算验证：`|涨跌幅 - (收盘价-前收盘价)/前收盘价×100| < 0.1`
- 停牌数据验证：`停牌标记为true时，成交量 == 0`
- 数据完整性验证：`必填字段非空率 > 99%`
- 异常值标记验证：`|涨跌幅| > 20时，异常标记 == true`
- 处理性能验证：`单批次1000条数据处理时间 < 1秒`

#### 3. 财务数据清洗器

**清洗规则**：
- 财务逻辑验证：资产=负债+股东权益（误差<1%）
- 比率计算验证：ROE=净利润/股东权益×100%
- 单位统一：统一为万元或亿元
- 时间序列验证：同比、环比数据逻辑检查

**异常处理**：
- 负值检查：资产、收入等不应为负值
- 极值检查：财务比率超出合理范围标记异常
- 重述调整：财务数据重述时更新历史数据

**验收标准**（可通过单元测试验证）：
- 财务等式验证：`|总资产 - (总负债 + 股东权益)| / 总资产 < 0.01`
- ROE计算验证：`|ROE - 净利润/股东权益×100| < 0.01`
- ROA计算验证：`|ROA - 净利润/总资产×100| < 0.01`
- 负值检查验证：`总资产 >= 0 && 营业收入 >= 0 && 股东权益 >= 0`
- 单位统一验证：`所有金额字段单位标识一致`
- 数据完整性验证：`核心财务字段非空率 > 99%`
- 比率合理性验证：`-100 <= ROE <= 100 && -100 <= ROA <= 100`
- 处理性能验证：`单批次100条财务数据处理时间 < 1秒`

#### 4. 新闻数据清洗器

**清洗规则**：
- 去重处理：基于标题和内容相似度去重
- 内容过滤：过滤广告、无关内容
- 关键词提取：提取股票代码、公司名称、行业关键词
- 情绪分析：正面、负面、中性情绪分类
- 时效性验证：新闻发布时间合理性检查

**标准化处理**：
- 统一时间格式：ISO 8601标准
- 统一编码格式：UTF-8
- 股票代码标准化：统一为6位数字格式

**验收标准**（通过人工抽样验证）：
- 数据格式标准化：时间格式、编码格式、股票代码格式100%符合规范
- 基础数据完整性：标题、内容、时间字段完整率>99%
- 去重功能正常：重复新闻数量<总数量的5%
- 关键词提取功能正常：能够识别和提取股票代码、公司名称
- 情绪分析功能正常：能够对新闻进行情绪分类标记

**注：新闻内容的语义分析和情绪判断准确性通过人工抽样评估，不纳入自动化测试范围**

#### 5. 政策数据清洗器

**清洗规则**：
- 政策分类：货币政策、财政政策、监管政策、产业政策
- 重要性评级：高、中、低三级重要性分类
- 影响范围：全市场、行业、个股影响范围标记
- 时效性标记：政策生效时间、失效时间

**标准化处理**：
- 政策文号标准化
- 发布机构标准化
- 政策类型标准化

**验收标准**（通过人工抽样验证）：
- 数据格式标准化：政策文号、发布机构、政策类型格式100%符合规范
- 基础数据完整性：标题、内容、发布时间、来源字段完整率>99%
- 分类功能正常：能够对政策进行类型分类标记
- 评级功能正常：能够对政策进行重要性评级
- 影响范围标记功能正常：能够标记政策影响范围

**注：政策内容的语义理解和影响评估准确性通过人工抽样评估，不纳入自动化测试范围**

### 数据采集功能
- 多数据源自动采集（股票、财务、新闻、政策）
- 定时任务调度
- 数据标准化处理
- 异常数据识别和处理
- 新闻情绪分析和关键词提取

### 数据存储功能
- 股票基础信息存储
- K线数据存储
- 财务数据存储
- 新闻和政策数据存储
- 历史数据管理

### 数据服务功能
- 数据查询API
- 实时数据订阅
- 复权因子查询API
- 全量数据初始化API

## 验收标准

### 功能验收
- 成功采集A股全市场股票基础信息
- 采集最近3年的日K线数据和财务数据
- 采集新闻和政策数据
- 采集任务按计划自动执行
- 提供完整的数据查询API
- 成功采集股票复权因子数据
- 全量初始化接口能够正常工作
- 复权因子查询API功能正常
- Token轮换机制正常工作，支持多token配置和自动切换
- Token异常处理机制有效，单个token失效时系统能够自动切换


### 性能验收
- 单日全市场数据采集时间<30分钟
- API响应时间<1秒
- 支持100个并发查询请求

### 质量验收
- 数据准确率>99%
- 数据完整率>99%
- 系统可用率>99.5%
- 数据延迟<5分钟

## 成功指标

### 关键指标
- A股市场覆盖率>95%
- 数据准确率>99%
- 系统连续运行7天无故障
- 查询性能：平均响应时间<500ms

### 业务指标
- 数据完整性：单日数据缺失率<1%
- 数据时效性：数据更新延迟<5分钟
- 内部服务调用成功率>99%

## 修改记录

[2024-01-20] 新增 初始版本创建，定义数据获取基础设施的完整需求
[2024-01-20] 优化 精简文档内容，移除技术实现细节，专注业务需求
[2024-01-20] 修改 删除数据监控相关用户故事和功能描述
[2024-01-20] 新增 补充新闻数据和政策数据采集需求
[2024-01-20] 新增 详细设计每种数据采集器的功能规范和验收标准
[2024-01-20] 新增 定义数据清洗器的作用、清洗规则和验收标准
[2024-12-20] 优化 优化数据清洗器验收标准，区分可单元测试和人工验证的标准
[2024-12-20] 补充 补充新闻和政策数据采集器的具体数据源页面和解析策略
[2024-12-20] 简化 简化新闻数据采集器，仅保留财联社作为数据源
[2024-12-20] 简化 简化政策数据采集器，仅保留央行和证监会核心政策源
[2025-01-20] 简化 进一步简化政策数据采集器，仅保留央行新闻发布
[2025-01-20] 修改 将股票基础数据、财务数据和市场数据采集器的主要数据源统一为Tushare Pro API
[2025-01-20] 新增 增加股票复权因子采集需求和复权因子查询API
[2025-01-20] 新增 增加全量数据初始化接口需求，支持一次性采集全市场股票基本信息
[2025-01-20] 简化 财联社新闻采集仅保留主页快讯，删除股市动态、公司新闻、政策解读三个数据源
[2025-01-20] 修改 简化财联社快讯采集内容，调整为快讯标题、内容、发布时间、关联股票和行业信息
[2025-01-20] 新增 增加Tushare Pro API Token轮换需求，包括多token配置、轮换策略、状态监控和异常处理